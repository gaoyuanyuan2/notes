# Web安全

比如一个网站的数据库，在没有保护的情况下，数据库服务端口是允许任何人随意连接的；
在有了防火墙的保护后，通过ACL可以控制只允许信任来源的访问。
这些措施在很大程度上保证了系统软件处于信任边界之内，从而杜绝了大部分的攻击来源。

SQL注入漏洞至今仍然是Web安全领域中的一个重要组成部分。
XSS（跨站脚本攻击）的出现则是Web安全史上的另一个里程碑。

如果新技术不在一开始就考虑安全设计的话，防御技术就必然会落后于攻击技术，导致历史不断地重复。

安全三要素是安全的基本组成元素，分别是机密性（Confidentiality）、完整性（Integrity）、可用性（Availability）。

完整性则要求保护数据内容是完整、没有被篡改的。常见的保证一致性的技术手段是数字签名。

拒绝服务攻击破坏的是安全的可用性。

互联网安全的核心问题，是数据安全的问题。

了解公司最重要的资产是什么，他们最看重的数据是什么

威胁分析就是把所有的威胁都找出来。怎么找？一般是采用头脑风暴法。
当然，也有一些比较科学的方法，比如使用一个模型，帮助我们去想，在哪些方面有可能会存在威胁，
这个过程能够避免遗漏，这就是威胁建模。

很多人认为，安全和业务是冲突的，因为往往为了安全，要牺牲业务的一些易用性或者性能，
笔者不太赞同这种观点。从产品的角度来说，安全也应该是产品的一种属性。
，至少是不完整的。

最终，一个优秀的安全方案应该具备以下特点：
* 能够有效解决问题；
* 用户体验好；
* 高性能；
* 低耦合；
* 易于扩展与升级。


在网站的生产环境服务器上，应该限制随意安装软件，而需要制定统一的软件版本规范。这个规范的制定，
也可以选择白名单的思想来实现。按照白名单的思想，应该根据业务需求，
列出一个允许使用的软件以及软件版本的清单，在此清单外的软件则禁止使用。
如果允许工程师在服务器上随意安装软件的话，则可能会因为安全部门不知道、不熟悉这些软件而导致一些漏洞，
从而扩大攻击面

所以在选择使用白名单时，需要注意避免出现类似通配符“*”的问题。

Secure By Default的另一层含义就是“最小权限原则”。最小权限原则也是安全设计的基本原则之一。
最小权限原则要求系统只授予主体必要的权限，而不要过度授权，这样能有效地减少系统、网络、应用、数据库出错的机会。

我们需要考虑的可能有Web应用安全、OS系统安全、数据库安全、网络环境安全

## CSRF

CSRF的全名是Cross Site Request Forgery，翻译成中文就是跨站点请求伪造。

Third-party Cookie是服务器在Set-Cookie时指定了Expire时间，只有到了Expire时间后Cookie才会失效，
所以这种Cookie会保存在本地；而Session Cookie则没有指定Expire时间，所以浏览器关闭后，
Session Cookie就失效了。

验证码被认为是对抗CSRF攻击最简洁而有效的防御方法。

Referer Check在互联网中最常见的应用就是“防止图片盗链”。同理，Referer Check也可以被用于检查请求是否来自合法的“源”。

现在业界针对CSRF的防御，一致的做法是使用一个Token。

CSRF为什么能够攻击成功？其本质原因是重要操作的所有参数都是可以被攻击者猜测到的。
攻击者只有预测出URL的所有参数与参数值，才能成功地构造一个伪造的请求；反之，攻击者将无法攻击成功。
出于这个原因，可以想到一个解决方案：把参数加密，或者使用一些随机数，从而让攻击者无法猜测到参数值。这是“不可预测性原则”的一种应用

Token需要同时放在表单和Session中。在提交请求时，服务器只需验证表单中的Token，与用户Session（或Cookie）中的Token是否一致，如果一致，则认为是合法请求；
如果不一致，或者有一个为空，则认为请求不合法，可能发生了CSRF攻击。

因此在使用Token时，应该尽量把Token放在表单中。
把敏感操作由GET改为POST，以form表单（或者AJAX）的形式提交，可以避免Token泄露。

CSRF的Token仅仅用于对抗CSRF攻击，当网站还同时存在XSS漏洞时，这个方案就会变得无效，
因为XSS可以模拟客户端浏览器执行任意操作。在XSS攻击下，攻击者完全可以请求页面后，
读出页面内容里的Token值，然后再构造出一个合法的请求。
这个过程可以称之为XSRF，和CSRF以示区分。

CSRF攻击是攻击者利用用户的身份操作用户账户的一种攻击方式。
设计CSRF的防御方案必须先理解CSRF攻击的原理和本质。
根据“不可预测性原则”，我们通常使用Anti CSRF Token来防御CSRF攻击。
在使用Token时，要注意Token的保密性和随机性。

点击劫持是一种视觉上的欺骗手段。攻击者使用一个透明的、不可见的iframe，覆盖在一个网页上，
然后诱使用户在该网页上进行操作，此时用户将在不知情的情况下点击透明的iframe页面。
通过调整iframe页面的位置，可以诱使用户恰好点击在iframe页面的一些功能性按钮上。

因此在现实中有非常多的站点存在被XSIO攻击的可能。在防御XSIO时，
需要检查用户提交的HTML代码中，<img>标签的style属性是否可能导致浮出。

“拖拽劫持”的思路是诱使用户从隐藏的不可见iframe中“拖拽”出攻击者希望得到的数据，
然后放到攻击者能控制的另外一个页面中，从而窃取数据。

ClickJacking是一种视觉上的欺骗，那么如何防御它呢？针对传统的ClickJacking，
一般是通过禁止跨域的iframe来防范。

<iframe>标签一直以来都为人所诟病。挂马、XSS、ClickJacking等攻击中都能看到它不光彩的身影。

## 注入攻击

注入攻击的本质，是把用户输入的数据当做代码执行。这里有两个关键条件，第一个是用户能够控制输入；第二个是原本程序要执行的代码，
拼接了用户输入的数据

防御SQL注入的最佳方式，就是使用预编译语句，绑定变量。

注入攻击是应用违背了“数据与代码分离原则”导致的结果。它有两个条件：一是用户能够控制数据的输入；二是代码拼凑了用户输入的数据，把数据当做代码执行了。
在对抗注入攻击时，只需要牢记“数据与代码分离原则”，在“拼凑”发生的地方进行安全检查，就能避免此类问题。

## 文件上传漏洞概述

文件上传漏洞是指用户上传了一个可执行的脚本文件，并通过此脚本文件获得了执行服务器端命令的能力。

首先，上传的文件能够被Web容器解释执行。所以文件上传后所在的目录要是Web容器所覆盖到的路径。
其次，用户能够从Web上访问这个文件。如果文件上传了，但用户无法通过Web访问，或者无法使得Web容器解释这个脚本，那么也不能称之为漏洞。
最后，用户上传的文件若被安全检查、格式化、图片压缩等功能改变了内容，则也可能导致攻击不成功。

设计安全的文件上传功能

1．文件上传的目录设置为不可执行

2．判断文件类型

3．使用随机数改写文件名和文件路径

4．单独设置文件服务器的域名


## 认证与会话管理

“认证”和“授权”两个概念搞混，甚至有些安全工程师也是如此。实际上“认证”和“授权”是两件事情，
认证的英文是Authentication，授权则是Authorization。
分清楚这两个概念其实很简单，只需要记住下面这个事实：
认证的目的是为了认出用户是谁，
而授权的目的是为了决定用户能够做什么。


目前黑客们常用的一种暴力破解手段，不是破解密码，而是选择一些弱口令，比如123456，然后猜解用户名，直到发现一个使用弱口令的账户为止。
由于用户名往往是公开的信息，攻击者可以收集一份用户名的字典，使得这种攻击的成本非常低，而效果却比暴力破解密码要好很多。

密码的保存也有一些需要注意的地方。一般来说，密码必须以不可逆的加密算法，或者是单向散列函数算法，加密后存储在数据库中。

Session与认证
密码与证书等认证手段，一般仅仅用于登录（Login）的过程。当登录完成后，用户访问网站的页面，不可能每次浏览器请求页面时都再使用密码认证一次。
因此，当认证成功后，就需要替换一个对用户透明的凭证。这个凭证，就是SessionID。


会话中会保存用户的状态和相关信息


最常见的做法就是把SessionID加密后保存在Cookie中，因为Cookie会随着HTTP请求头发送


Cookie泄露的途径有很多，最常见的有XSS攻击、网络Sniff，以及本地木马窃取。
对于通过XSS漏洞窃取Cookie的攻击，通过给Cookie标记httponly，可以有效地缓解XSS窃取Cookie的问题。
但是其他的泄露途径，比如网络被嗅探，或者Cookie文件被窃取，则会涉及客户端的环境安全，需要从客户端着手解决。

SessionID除了可以保存在Cookie中外，还可以保存在URL中，作为请求的一个参数。但是这种方式的安全性难以经受考验。

在手机操作系统中，由于很多手机浏览器暂不支持Cookie。


但有一些系统，出于用户体验的考虑，只要这个用户还“活着”，就不会让这个用户的Session失效。
从而攻击者可以通过不停地发起访问请求，让Session一直“活”下去。

SSO的优点在于风险集中化，就只需要保护好这一个点。

降低这种风险的办法是在一些敏感的系统里，再单独实现一些额外的认证机制。比如网上支付平台，
在付款前要求用户再输入一次密码，或者通过手机短信验证用户身份等

以双因素认证或多因素认证的方式，提高系统的安全强度。

在Web应用中，根据访问客体的不同，常见的访问控制可以分为“基于URL的访问控制”、
“基于方法（method）的访问控制”和“基于数据的访问控制”。


Spring Security提供了一系列的“Filter Chain”，每个安全检查的功能都会插入在这个链条中。
在与Web系统集成时，开发者只需要将所有用户请求的URL都引入到Filter Chain即可。


## OAuth

OAuth是一个在不提供用户名和密码的情况下，授权第三方应用访问Web资源的安全协议。

OAuth与OpenID都致力于让互联网变得更加的开放。OpenID解决的是认证问题，OAuth则更注重授权。

Request Token只能用于获取用户的授权，Access Token才能用于访问用户的资源。


## 服务器攻击

很多JSP网站的管理员喜欢将Tomcat配置为root身份运行，
导致的后果就是黑客们通过漏洞得到了webshell后，发现这个webshell已经具备root权限了。

一般来说，攻击者入侵成功后，要做的第一件事情就是清除入侵痕迹，修改、删除日志文件，
因此access log应当妥善保管，比如实时地发送到远程的syslog服务器上。

安全是产品的一种特性，如果我们的产品能够潜移默化地培养用户的安全习惯，
将用户往更安全的行为上引导，那么这样的安全就是最理想的产品安全。

为了避免本案例中出现的逻辑漏洞，就不应该再锁定账户，而是应该锁定来自某一IP地址的请求。

比如Cookie劫持导致的账户被盗，黑客是不知道用户密码的。因此修改密码时不询问当前密码，是一个逻辑漏洞。

##



















